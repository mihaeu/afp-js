#!/usr/bin/env node
'use strict';

const fs = require('fs');

fs.readdir('./code-samples/src', (err, files) => {

  var code = "";
  files.forEach(file => code += fs.readFileSync('./code-samples/src/' + file, 'utf8'));

  var i, lines, codeSamples = [], currentSample = "", spaces = 0;
  for (i = 0, lines = code.split("\n"); i < lines.length; i++) {
    if (lines[i].match(/.*\/\/ @sample start: .+/) !== null) {
      currentSample = lines[i].replace(/.*\/\/ @sample start: (.+)/, '$1');
      spaces = lines[i].replace(/(.*)\/\/ @sample start: .+/, '$1').length;
      codeSamples[currentSample] = '';
    } else if (lines[i].match(/.*\/\/ @sample end: .+/) !== null) {
      currentSample = "";
    } else if (currentSample !== "") {
      codeSamples[currentSample] += lines[i].slice(spaces) + "\n";
    }
  }

  var presentation = fs.readFileSync('template.html', 'utf8')
    .split("\n")
    .map(line => line.replace(/\/\/ @sample: (\S+)/, (string, match) => {
      if (codeSamples[match] == undefined) {
        throw new Error('There\'s no code sample that matches ' + string);
      }
      return codeSamples[match];
  })).join("\n");
  process.stdout.write(presentation);
});